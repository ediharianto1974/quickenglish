<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Year 6 Grammar Portal - Step-by-Step</title>
    <style>
        :root { --primary: #4f46e5; --success: #22c55e; --danger: #ef4444; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .container { max-width: 800px; margin: 0 auto; }
        
        .header { background: linear-gradient(135deg, var(--primary), #818cf8); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
        
        /* Setup Section */
        .setup-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
        input[type="text"], select { flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #e2e8f0; font-size: 1rem; }

        /* Progress Bar */
        .progress-container { background: #e2e8f0; height: 10px; border-radius: 5px; margin-bottom: 20px; display: none; overflow: hidden; }
        .progress-bar { background: var(--primary); height: 100%; width: 0%; transition: 0.3s; }

        /* Topic Display */
        .topic-container { display: none; }
        .topic-card { background: white; padding: 25px; border-radius: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .q-item { margin-bottom: 20px; padding: 15px; border-bottom: 1px solid #f1f5f9; }
        
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-top: 10px; }
        .opt-btn { background: white; border: 2px solid #e2e8f0; padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; }
        .opt-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* Navigation Buttons */
        .nav-controls { margin-top: 20px; display: flex; gap: 10px; }
        .btn { padding: 15px 25px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; flex: 1; font-size: 1rem; }
        .btn-start { background: var(--primary); color: white; }
        .btn-next { background: var(--primary); color: white; }
        .btn-submit { background: var(--success); color: white; display: none; }

        /* Results Area */
        #resultArea { display: none; background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary); margin-top: 20px; }
        .result-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .correct-ans { color: var(--success); font-weight: bold; }
        .wrong-ans { color: var(--danger); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header" id="mainHeader">
        <h1>Grammar Portal Year 6</h1>
        <p>One Topic at a Time</p>
    </div>

    <div class="setup-card" id="setupCard">
        <div class="input-group">
            <input type="text" id="studentName" placeholder="Full Name">
            <input type="text" id="studentClass" placeholder="Class">
        </div>
        <select id="setMenu"><option value="">Loading sets...</option></select>
        <button class="btn btn-start" style="margin-top:15px; width:100%" onclick="initQuiz()">Start Practice</button>
    </div>

    <div class="progress-container" id="progCont"><div class="progress-bar" id="progBar"></div></div>
    
    <div id="quizContent"></div>

    <div class="nav-controls" id="navArea" style="display:none">
        <button id="nextBtn" class="btn btn-next" onclick="nextStep()">Next Topic â†’</button>
        <button id="submitBtn" class="btn btn-submit" onclick="finishQuiz()">Check Answers & Generate Report</button>
    </div>

    <div id="resultArea">
        <h2 style="text-align:center">Performance Report</h2>
        <div id="studentDetail" style="margin-bottom:15px; padding:10px; background:#f1f5f9; border-radius:8px"></div>
        <div id="topicSummary"></div>
        <div id="finalGrade" style="font-size:1.5rem; text-align:center; margin-top:20px; color:var(--primary)"></div>
        <button class="btn" style="background:#334155; color:white; width:100%; margin-top:20px" onclick="downloadTextReport()">Download Report (.txt)</button>
        <button class="btn" style="background:#cbd5e1; margin-top:10px; width:100%" onclick="location.reload()">Try Another Set</button>
    </div>
</div>

<script>
    let fullData = null;
    let currentTopicIdx = 0;
    let userAnswers = []; // Store all answers: {tIdx, qIdx, ans}

    // Load Manifest
    window.onload = async () => {
        try {
            const res = await fetch('manifest.json');
            const data = await res.json();
            const menu = document.getElementById('setMenu');
            menu.innerHTML = '<option value="">-- Select Set --</option>';
            data.available_sets.forEach(s => menu.innerHTML += `<option value="${s.file}">${s.name}</option>`);
        } catch (e) { alert("Manifest not found!"); }
    };

    // Initialize Quiz
    async function initQuiz() {
        const name = document.getElementById('studentName').value;
        const sClass = document.getElementById('studentClass').value;
        const file = document.getElementById('setMenu').value;

        if(!name || !sClass || !file) return alert("Please fill all details!");

        try {
            const res = await fetch(file);
            const data = await res.json();
            fullData = data.modul_latihan_bahasa_inggeris_tahun_6;
            
            document.getElementById('setupCard').style.display = 'none';
            document.getElementById('progCont').style.display = 'block';
            document.getElementById('navArea').style.display = 'flex';
            
            showTopic(0);
        } catch (e) { alert("Load error."); }
    }

    // Show specific topic
    function showTopic(idx) {
        currentTopicIdx = idx;
        const topic = fullData.latihan[idx];
        const container = document.getElementById('quizContent');
        
        // Update Progress Bar
        const percent = ((idx + 1) / fullData.latihan.length) * 100;
        document.getElementById('progBar').style.width = percent + "%";

        let html = `<div class="topic-card">
            <h2 style="color:var(--primary)">${topic.topik}</h2>
            <p><i>${topic.arahan}</i></p><hr style="border:1px solid #f1f5f9">`;

        topic.soalan.forEach((q, qIdx) => {
            html += `<div class="q-item">
                <p><strong>${qIdx + 1}.</strong> ${q.teks}</p>`;
            
            if(q.pilihan) {
                html += `<div class="options-grid">`;
                q.pilihan.forEach(opt => {
                    const isSel = getSavedAns(idx, qIdx) === opt ? 'selected' : '';
                    html += `<div class="opt-btn ${isSel}" onclick="saveAns(${idx}, ${qIdx}, '${opt}', this)">${opt}</div>`;
                });
                html += `</div>`;
            } else {
                const val = getSavedAns(idx, qIdx) || '';
                html += `<input type="text" placeholder="Type answer..." value="${val}" onchange="saveAns(${idx}, ${qIdx}, this.value)">`;
            }
            html += `</div>`;
        });
        html += `</div>`;
        
        container.innerHTML = html;
        
        // Toggle Buttons
        if(idx === fullData.latihan.length - 1) {
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'block';
        } else {
            document.getElementById('nextBtn').style.display = 'block';
            document.getElementById('submitBtn').style.display = 'none';
        }
        window.scrollTo(0,0);
    }

    function saveAns(tIdx, qIdx, val, el) {
        if(el) { // MCQ logic
            const parent = el.parentElement;
            Array.from(parent.children).forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }
        const existing = userAnswers.find(a => a.tIdx === tIdx && a.qIdx === qIdx);
        if(existing) existing.ans = val;
        else userAnswers.push({tIdx, qIdx, ans: val});
    }

    function getSavedAns(tIdx, qIdx) {
        const found = userAnswers.find(a => a.tIdx === tIdx && a.qIdx === qIdx);
        return found ? found.ans : null;
    }

    function nextStep() {
        showTopic(currentTopicIdx + 1);
    }

    function finishQuiz() {
        document.getElementById('quizContent').style.display = 'none';
        document.getElementById('navArea').style.display = 'none';
        document.getElementById('progCont').style.display = 'none';
        document.getElementById('mainHeader').style.display = 'none';
        
        const summaryCont = document.getElementById('topicSummary');
        let grandTotal = 0;
        let grandMax = 0;
        
        let reportDetails = "";

        fullData.latihan.forEach((topic, tIdx) => {
            let tScore = 0;
            topic.soalan.forEach((q, qIdx) => {
                const uA = (getSavedAns(tIdx, qIdx) || "").toLowerCase().trim();
                if(uA === q.jawapan.toLowerCase().trim()) tScore++;
            });
            
            const tMax = topic.soalan.length;
            grandTotal += tScore;
            grandMax += tMax;
            
            const perc = Math.round((tScore/tMax)*100);
            const remark = perc >= 80 ? "Excellent" : perc >= 50 ? "Good" : "Needs Practice";
            
            summaryCont.innerHTML += `<div class="result-row">
                <span>Topic ${tIdx+1}: ${topic.topik}</span>
                <span><b>${tScore}/${tMax}</b> - ${remark}</span>
            </div>`;
            
            reportDetails += `Topic ${tIdx+1}: ${topic.topik.padEnd(20)} | ${tScore}/${tMax} (${remark})\n`;
        });

        const finalPerc = Math.round((grandTotal/grandMax)*100);
        document.getElementById('finalGrade').innerText = `Final Score: ${grandTotal}/${grandMax} (${finalPerc}%)`;
        document.getElementById('studentDetail').innerHTML = `
            <b>Name:</b> ${document.getElementById('studentName').value}<br>
            <b>Class:</b> ${document.getElementById('studentClass').value}<br>
            <b>Set:</b> ${document.getElementById('setMenu').options[document.getElementById('setMenu').selectedIndex].text}
        `;
        document.getElementById('resultArea').style.display = 'block';
        window.finalReportText = reportDetails; // Store for download
    }

    function downloadTextReport() {
        const name = document.getElementById('studentName').value;
        const sClass = document.getElementById('studentClass').value;
        const score = document.getElementById('finalGrade').innerText;
        
        let txt = `OFFICIAL GRAMMAR REPORT\n========================\n`;
        txt += `Student : ${name}\nClass   : ${sClass}\nDate    : ${new Date().toLocaleString()}\n\n`;
        txt += `BREAKDOWN BY TOPIC:\n------------------------\n`;
        txt += window.finalReportText;
        txt += `\n------------------------\n${score}\n========================`;
        
        const blob = new Blob([txt], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Report_${name}.txt`;
        a.click();
    }
</script>

</body>
</html>
